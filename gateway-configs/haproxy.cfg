# HAProxy Configuration for Sui Discovery Gateway Integration
#
# This configuration demonstrates how to integrate HAProxy with
# the Sui Discovery validation API

global
    log stdout format raw local0
    maxconn 4096
    
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Validation service backend
backend validation_service
    mode http
    balance roundrobin
    server validation1 localhost:3000 check

# Protected API backend  
backend protected_api
    mode http
    balance roundrobin
    server api1 localhost:8080 check

# Frontend that handles validation
frontend api_gateway
    bind *:80
    mode http
    
    # Extract API key from headers
    http-request set-var(req.api_key) req.hdr(Authorization)
    http-request replace-value api_key "^Bearer (.+)" "\\1" if { var(req.api_key) -m found }
    
    # If no Authorization header, try X-API-Key
    http-request set-var(req.api_key) req.hdr(X-API-Key) if !{ var(req.api_key) -m found }
    
    # Deny if no API key
    http-request deny deny_status 401 content-type application/json string '{"error":"Missing API key"}' if !{ var(req.api_key) -m found }
    
    # Set service ID (change this for your service)
    http-request set-var(req.service_id) str("1")
    
    # Validate with external service
    http-request lua.validate_entitlement
    
    # Deny if validation failed
    http-request deny deny_status 403 content-type application/json string '{"error":"Access denied"}' if { var(req.validated) -m str "false" }
    
    # Add quota headers to response
    http-response set-header X-Quota-Remaining %[var(req.quota_remaining)]
    http-response set-header X-Quota-Limit %[var(req.quota_limit)]
    
    # Route to protected API
    default_backend protected_api

# Note: HAProxy requires Lua script for advanced validation
# Save this as /etc/haproxy/validation.lua:
#
# function validate_entitlement(txn)
#     local http = require("socket.http")
#     local json = require("json")
#     
#     local api_key = txn:get_var("req.api_key")
#     local service_id = txn:get_var("req.service_id")
#     local endpoint = txn.sf:path()
#     local method = txn.sf:method()
#     
#     local body = json.encode({
#         apiKey = api_key,
#         serviceId = tonumber(service_id),
#         endpoint = endpoint,
#         method = method
#     })
#     
#     local response = http.request("http://localhost:3000/api/entitlements/verify", {
#         method = "POST",
#         headers = {
#             ["Content-Type"] = "application/json",
#             ["Content-Length"] = #body
#         },
#         body = body
#     })
#     
#     local result = json.decode(response)
#     
#     if result.allowed then
#         txn:set_var("req.validated", "true")
#         txn:set_var("req.quota_remaining", tostring(result.quotaRemaining))
#         txn:set_var("req.quota_limit", tostring(result.quotaLimit))
#         txn:set_var("req.entitlement_id", tostring(result.entitlementId))
#     else
#         txn:set_var("req.validated", "false")
#     end
# end
#
# core.register_action("validate_entitlement", { "http-req" }, validate_entitlement)
