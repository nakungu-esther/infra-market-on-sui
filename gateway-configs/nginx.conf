# NGINX Configuration for Sui Discovery Gateway Integration
# 
# This configuration demonstrates how to integrate NGINX with
# the Sui Discovery validation API for entitlement checking

# Upstream validation service
upstream validation_service {
    server localhost:3000;
    keepalive 32;
}

# Upstream protected API
upstream protected_api {
    server localhost:8080;
    keepalive 32;
}

# Rate limiting zone
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;

server {
    listen 80;
    server_name api.example.com;

    # Service ID (set this for your service)
    set $service_id 1;

    location / {
        # Apply rate limiting
        limit_req zone=api_limit burst=20 nodelay;

        # Extract API key from Authorization header or X-API-Key
        set $api_key "";
        if ($http_authorization ~* "Bearer (.+)") {
            set $api_key $1;
        }
        if ($http_x_api_key) {
            set $api_key $http_x_api_key;
        }

        # Validate entitlement before proxying
        auth_request /validate;
        auth_request_set $quota_remaining $upstream_http_x_quota_remaining;
        auth_request_set $quota_limit $upstream_http_x_quota_limit;
        auth_request_set $entitlement_id $upstream_http_x_entitlement_id;

        # Add custom headers to upstream request
        proxy_set_header X-API-Key $api_key;
        proxy_set_header X-Entitlement-Id $entitlement_id;
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Add quota headers to response
        add_header X-Quota-Remaining $quota_remaining always;
        add_header X-Quota-Limit $quota_limit always;

        # Proxy to protected API
        proxy_pass http://protected_api;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Track usage after successful request (background)
        post_action @track_usage;
    }

    # Internal validation endpoint
    location = /validate {
        internal;
        proxy_pass http://validation_service/api/entitlements/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        
        # Send validation request body
        proxy_method POST;
        proxy_set_header Content-Type "application/json";
        proxy_set_body '{
            "apiKey": "$api_key",
            "serviceId": $service_id,
            "endpoint": "$request_uri",
            "method": "$request_method",
            "clientIp": "$remote_addr"
        }';
    }

    # Internal usage tracking endpoint (async)
    location @track_usage {
        internal;
        proxy_pass http://validation_service/api/usage/track;
        proxy_method POST;
        proxy_set_header Content-Type "application/json";
        proxy_set_body '{
            "entitlementId": $entitlement_id,
            "endpoint": "$request_uri",
            "method": "$request_method",
            "statusCode": $status,
            "responseTime": $request_time,
            "bytesTransferred": $bytes_sent
        }';
    }

    # Error responses
    error_page 401 = @error401;
    error_page 403 = @error403;
    
    location @error401 {
        default_type application/json;
        return 401 '{"error":"Unauthorized","message":"Invalid or missing API key"}';
    }
    
    location @error403 {
        default_type application/json;
        return 403 '{"error":"Forbidden","message":"Quota exceeded or access denied"}';
    }
}
